<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Redis入坑笔记 | Raykie’s blog</title><meta name="author" content="Raykie"><meta name="copyright" content="Raykie"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Redis入坑笔记（道）  什么是Redis  Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker. It supports data structures such as strings, hashes, list">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis入坑笔记">
<meta property="og:url" content="http://example.com/2020/11/23/Redis%E5%85%A5%E5%9D%91%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Raykie’s blog">
<meta property="og:description" content="Redis入坑笔记（道）  什么是Redis  Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker. It supports data structures such as strings, hashes, list">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://download.logo.wine/logo/Redis/Redis-Logo.wine.png">
<meta property="article:published_time" content="2020-11-22T16:04:02.000Z">
<meta property="article:modified_time" content="2021-01-29T13:43:51.926Z">
<meta property="article:author" content="Raykie">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://download.logo.wine/logo/Redis/Redis-Logo.wine.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/GayHub1/images/img/favicon.png"><link rel="canonical" href="http://example.com/2020/11/23/Redis%E5%85%A5%E5%9D%91%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4bf55317870f35ca7fa52050e6e77f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis入坑笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-01-29 21:43:51'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/GayHub1/images/img/jpg.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/rsshub"><i class="fa-fw fas fa-rss-square"></i><span> RSSHUB</span></a></li><li><a class="site-page child" href="/ttrss"><i class="fa-fw fas fa-book-reader"></i><span> TTRSS</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://download.logo.wine/logo/Redis/Redis-Logo.wine.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Raykie’s blog"><img class="site-icon" src="https://cdn.jsdelivr.net/gh/GayHub1/images/img/jpg.jpg"/><span class="site-name">Raykie’s blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/rsshub"><i class="fa-fw fas fa-rss-square"></i><span> RSSHUB</span></a></li><li><a class="site-page child" href="/ttrss"><i class="fa-fw fas fa-book-reader"></i><span> TTRSS</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis入坑笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-22T16:04:02.000Z" title="发表于 2020-11-23 00:04:02">2020-11-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-01-29T13:43:51.926Z" title="更新于 2021-01-29 21:43:51">2021-01-29</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="leancloud_visitors" id="/2020/11/23/Redis%E5%85%A5%E5%9D%91%E7%AC%94%E8%AE%B0/" data-flag-title="Redis入坑笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="leancloud-visitors-count"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="redis入坑笔记道"><a class="markdownIt-Anchor" href="#redis入坑笔记道"></a> Redis入坑笔记（道）</h1>
<h2 id="什么是redis查看源图像"><a class="markdownIt-Anchor" href="#什么是redis查看源图像"></a> 什么是Redis<img src="https://download.logo.wine/logo/Redis/Redis-Logo.wine.png" alt="查看源图像" /></h2>
<blockquote>
<p>Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker. It supports data structures such as strings, hashes, lists, sets, sorted sets with range queries, bitmaps, hyperloglogs, geospatial indexes with radius queries and streams. Redis has built-in replication, Lua scripting, LRU eviction, transactions and different levels of on-disk persistence, and provides high availability via Redis Sentinel and automatic partitioning with Redis Cluster</p>
</blockquote>
<p>以上是Redis官网对redis的简介，可以看出这是一个基于内存的非关系型的数据库，但是作用不仅仅是数据库还可以作为缓存以及消息的中间件。多种数据类型。虽然是基于内存的数据库也支持磁盘持久化。并且可以提供高可用的一些方案。</p>
<h2 id="redis安装"><a class="markdownIt-Anchor" href="#redis安装"></a> Redis安装</h2>
<h3 id="windows安装"><a class="markdownIt-Anchor" href="#windows安装"></a> Windows安装</h3>
<p>在Window下的安装较为简单，在<a target="_blank" rel="noopener" href="https://github.com/microsoftarchive/redis/releases">Windows</a> 页面选择最新版本下载。安装即可 ()</p>
<h3 id="linux安装"><a class="markdownIt-Anchor" href="#linux安装"></a> Linux安装</h3>
<p>Linux 可以通过docker安装或者编译安装 ，相对来说docker安装比较方便。</p>
<h4 id="docker安装"><a class="markdownIt-Anchor" href="#docker安装"></a> docker安装</h4>
<p>拉取镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull redis:latest</span><br></pre></td></tr></table></figure>
<p>运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --name redis-test -p 6379:6379 redis</span><br></pre></td></tr></table></figure>
<h4 id="编译安装"><a class="markdownIt-Anchor" href="#编译安装"></a> 编译安装</h4>
<p>安装redis之前先安装C++编译环境，gcc</p>
<p>安装gcc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc-c++</span><br></pre></td></tr></table></figure>
<p>去官网下载使用wget命令获取redis最新压缩包 ，官网也提供了安装命令。tar命令解压（建议解压到opt路径下），cd到解压的路径，使用make命令编译。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-6.0.8.tar.gz</span><br><span class="line">mv  redis-6.0.8.tar.gz /opt</span><br><span class="line">tar -xzf redis-6.0.8.tar.gz</span><br><span class="line">cd redis-6.0.8</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>程序已经默认安装好在/usr/loacl/bin下了</p>
<h3 id="启动"><a class="markdownIt-Anchor" href="#启动"></a> 启动</h3>
<p>redis 默认并不是后台启动 ，需要修改config中 <strong>daemonize</strong>属性改为yes</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server  redis.config</span><br></pre></td></tr></table></figure>
<h3 id="使用redis客户端连接"><a class="markdownIt-Anchor" href="#使用redis客户端连接"></a> 使用redis客户端连接</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reids-cli -h 127.0.0.1  -p 6379</span><br></pre></td></tr></table></figure>
<p>cli连接后关闭redis</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown</span><br></pre></td></tr></table></figure>
<h2 id="常用命令"><a class="markdownIt-Anchor" href="#常用命令"></a> 常用命令</h2>
<ul>
<li>
<p>查询所有key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="数据结构"><a class="markdownIt-Anchor" href="#数据结构"></a> 数据结构</h2>
<p>Redis底层数据结构一共有 6 种，分别是简单动态字符串、双向链表、压缩列表、哈希表、跳表和整数数组。利用各个数据结构不同的特性，在不同的场景下，动态组成了了各种数据类型，对应关系如下图所示：</p>
<p><img src="https://gitee.com/xiaozhuo_Q/images/raw/master/blog/image-20210113220722832.png" alt="image-20210113220722832" /></p>
<p>Redis作为一个典型的键值对数据库，我们先来看看它的键值对都是如何保存的。<br />
首先Redis服务器中每个服务器都是存在RedisService中长度为dbnum（默认为16）的RedisDB数组中，所以redis默认拥有16个数据库的。<br />
RedisDB数组中每个数据库使用Redisdb结构来表示，而RedisDB数据库结构下的dict字典就保存该数据库所有的键值对信息；</p>
<p><img src="https://gitee.com/xiaozhuo_Q/images/raw/master/blog/image-20210113223224391.png" alt="image-20210113223224391" /></p>
<h3 id="dict-字典哈希表"><a class="markdownIt-Anchor" href="#dict-字典哈希表"></a> Dict 字典/哈希表</h3>
<p>dict字典的底层是使用哈希表实现的，通过这哈希表可以高效的完成键值的关联与对键值对的管理。</p>
<p>而哈希表就是多个哈希桶构成的数组。每个键值对根据键的哈希值存储在相应的哈希桶中，存储在相同哈希桶的键值对的哈希节点通过链地址法连接。因而每个键值对节点都有指向对应key，val，以及下一个节点的指针。</p>
<p><img src="https://gitee.com/xiaozhuo_Q/images/raw/master/blog/image-20210118105401587.png" alt="image-20210118105401587" /></p>
<p>那么作为一个哈希表，重点往往在散列函数，哈希冲突，扩容机制这几个点。</p>
<p><strong>散列函数</strong>的作用在于计算哈希key最终存储在哪个哈希槽上，因此散列函数的算法除了效率还需要尽可能的将每个节点均匀地分散到哈希槽上，让散列尽可能的均匀。</p>
<p>redis在字典中具体使用散列的算法是 Murmurhash2。Murmurhash2是一种非加密hash算法，相对其他哈希散列算法。</p>
<blockquote>
<p><em>这种算法即使输入的键是有规律的，算法仍能给出一个很好的随机分布性，计算速度非常快，使用简单。</em></p>
</blockquote>
<p><strong>哈希冲突</strong> 当多个哈希节点被分配到同一个哈希槽时就会产生哈希冲突，在redis中就使用链地址法来解决，每个节点都有一个next指针来连接下一个节点，用链地址的形式连接多个节点在同一个哈希槽上现成一个单向链表，每加入一个新的节点时，由于每个哈希槽指针只指向链表的表头，所以是使用头插法，插入到链表的表头位置。</p>
<p><strong>渐近式rehash</strong></p>
<p>由于当哈希表内所保存的哈希节点越来越多时，就需要对哈希表的大小进行扩容，通过增加哈希桶的方式，使整个哈希表的负载因子（used/size）即每一个哈希桶内链表的个数在一个合理的范围。扩容的具体方式就用上了dict结构下的rehashidx变量与ht数组中另一个哈希表了。那么具体是如何进行渐进式rehash的呢？</p>
<ol>
<li>
<p>为另一个空闲的新哈希表分配空间。空间大小为&gt;= 两倍旧哈希表所承载节点的2^n次方。（收缩时为一倍）</p>
</li>
<li>
<p>将rehashidx由默认值-1设为0；开始渐进式rehash。</p>
</li>
<li>
<p>每当对字典进行操作时，除了执行原本的操作还会将旧哈希表rehashidx索引对应的哈希槽内所有的哈希节点进行rehash（重新计算哈希值并根据新哈希表大小计算出在新哈希表的哈希槽）到新的哈希表。然后rehashidx++；</p>
</li>
<li>
<p>当对旧哈希表所有的键值对都rehash到新的哈希表时重新将rehashidx设为-1.</p>
</li>
<li>
<p>释放的哈希表。将指向旧哈希表的指针指向新的哈希表，为原本新哈希表指针指向一个新的哈希表。这样整个渐进式rehash过程就完成了。</p>
<p>这种渐进式rehash的方式保证了每一次的哈希表rehash的量不会过多，时间不会过久阻塞了单线程的redis。</p>
<p>rehash的扩容触发条件会根据redis是否有在创建子进程（BGSAVE与BGREWRITEAOF）而改变。当有进行创建子进程的操作时，只有负载因子大于5才会进行rehash扩容否则只需大于1就可以进行rehash了。当负载因子小于0.1就会进行缩小。</p>
<p>在渐进式rehash期间对字典的所有操作都会针对新旧哈希表进行操作的。</p>
</li>
</ol>
<h3 id="整数集合"><a class="markdownIt-Anchor" href="#整数集合"></a> 整数集合</h3>
<h3 id="双向链表"><a class="markdownIt-Anchor" href="#双向链表"></a> 双向链表</h3>
<h3 id="压缩列表"><a class="markdownIt-Anchor" href="#压缩列表"></a> 压缩列表</h3>
<h3 id="skiplist-跳跃表"><a class="markdownIt-Anchor" href="#skiplist-跳跃表"></a> skiplist 跳跃表</h3>
<p>​	Redis使用跳跃表(skiplist)作为有序集合键的底层实现之一。skiplist本质上也是一种查找结构，用于解决算法中的查找问题（Searching）。一般查找问题的解法分为两个大类：一个是基于各种平衡树，一个是基于哈希表。但skiplist却比较特殊，它没法归属到这两大类里面。因为他是基于链表实现的。算是分治查找使用链表，在牺牲空间复杂度情况下产生的结构。</p>
<p>​	传统意义的单链表是一个线性结构。像有序的链表中大部分操作例如：插入，查找 都是需要一个O(n)的时间；</p>
<p><img src="http://images.zhuoke.xyz/img/20150530162529554" alt="img" /></p>
<p>​	先来看看skiplist比较基础的结构图，使用上图中所看到的的跳跃表。由于我们能够先通过每一个节点的最上层的指针先进行查找，将查找的值与目前节点的后继节点的值进行对比，如果大于则继续与后继指针对比，否则就下沉一层然后继续循环，直到找到该值在跳跃表的位置。（最后一定下沉到最下层）这样子就能跳过大部分的节点。然后再缩减范围，对以下一层的指针进行查找，若仍未找到，缩小范围继续查找。通过在每个节点增加多个后继指针就能够大大降低降低查找所需时间。原本O（n）也降低到O(logn);</p>
<p>基于redis是一种内存数据库，所以像使用B+tree实现索引这一类的数据结构只使用于存储在磁盘的mysql之类的数据库。基于哈希表又不满足数据库多样的需求，Redis 中的有序集合支持的核心操作主要有下面这几个：</p>
<ul>
<li>插入一个数据</li>
<li>删除一个数据</li>
<li>查找一个数据</li>
<li>按照区间查找数据（比如查找在[100,356]之间的数据）</li>
<li>迭代输出有序序列</li>
</ul>
<p>其中，插入、查找、删除以及迭代输出有序序列这几个操作，红黑树也能完成，时间复杂度和跳表是一样的，但是，按照区间来查找数据这个操作，红黑树的效率没有跳表高。</p>
<h3 id="sds-简单动态字符串"><a class="markdownIt-Anchor" href="#sds-简单动态字符串"></a> SDS 简单动态字符串</h3>
<p>关于String类型底层的数据结构，虽然redis是使用c编写的，但是String并没有用c语言的字符串来实现。而是使用了一种简单动态字符串（simple dynamic string），即SDS作为Redis默认字符串的数据结构。<strong>SDS</strong></p>
<p>用于在以下方面</p>
<ul>
<li>
<p>数据库的字符串</p>
</li>
<li>
<p>缓冲区（AOF模块的AOF缓冲区；客户端状态的输入缓冲区）</p>
<p>可以看到SDS被大量应用在数据快速修改的场景。而C字符串长度每一次增加或减少都会程序都需要进行一次内存重分配。而SDS结构则进行了优化。类似于ArrayList，通过一些冗余空间来减少内存重新分配的次数，我们先来看一下SDS的结构。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct sdshdr &#123;</span><br><span class="line"></span><br><span class="line">//字符串长度</span><br><span class="line"></span><br><span class="line">   int len;</span><br><span class="line"></span><br><span class="line">//空闲字节</span><br><span class="line"></span><br><span class="line">   int free;</span><br><span class="line"></span><br><span class="line">//实际存储数据buf的char型数组</span><br><span class="line"></span><br><span class="line">    char buf[];</span><br><span class="line">&#125;;      </span><br></pre></td></tr></table></figure>
<p>SDS整个结构还是相对比较简单明了，直接存储了字符串的长度以及另外存储数组空闲字节</p>
<p>，这样设计就可以<strong>直接获得字符串长度</strong>，而不用遍历到空字符；另外使得存储数据的buf数组不用跟c字符串一样，强制使数据量与存储数据的数组容量一致，实现<strong>空间预分配</strong>与<strong>惰性空间</strong>释放大大减少了数据变化后内存空间重分配的次数。虽然SDS与C字符串一样以空字符结尾，但是SDS的APi都是二进制安全的，不但可以<strong>避免缓冲区溢出</strong>而且<strong>可以使用原本C&lt;string.h&gt;中部分函数</strong>。还可以保存二进制数据(图片，音视频等文件)。</p>
</li>
</ul>
<h3 id="redis-model"><a class="markdownIt-Anchor" href="#redis-model"></a> Redis Model</h3>
<h2 id="数据类型"><a class="markdownIt-Anchor" href="#数据类型"></a> <strong>数据类型</strong></h2>
<h3 id="string"><a class="markdownIt-Anchor" href="#string"></a> String</h3>
<h4 id="命令"><a class="markdownIt-Anchor" href="#命令"></a> 命令</h4>
<ul>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/set.html">SET</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/get.html">GET</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/setnx.html">SETNX</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/setex.html">SETEX</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/psetex.html">GETEX</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/getset.html">GETSET</a>    获取赋值</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/append.html">APPEND</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/setrange.html">SETRANGE</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/getrange.html">GETRANGE</a>   局部修改</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/incr.html">INCR</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/incrby.html">INCRBY</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/incrbyfloat.html">INCRBYFLOAT</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/decr.html">DECR</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/decrby.html">DECRBY</a> 增量/减量</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/mset.html">MSET</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/msetnx.html">MSETNX</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/string/mget.html">MGET</a> 批量操作</li>
</ul>
<h3 id="hash"><a class="markdownIt-Anchor" href="#hash"></a> Hash</h3>
<h4 id="命令-2"><a class="markdownIt-Anchor" href="#命令-2"></a> 命令</h4>
<ul>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hset.html">HSET</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hsetnx.html">HSETNX</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hget.html">HGET</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hkeys.html">HKEYS</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hvals.html">HVALS</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hexists.html">HEXISTS</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hdel.html">HDEL</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hlen.html">HLEN</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hstrlen.html">HSTRLEN</a>   对field 单独的操作</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hincrby.html">HINCRBY</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hincrbyfloat.html">HINCRBYFLOAT</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hmset.html">HMSET</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hmget.html">HMGET</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hgetall.html">HGETALL</a></li>
</ul>
<h3 id="list"><a class="markdownIt-Anchor" href="#list"></a> List</h3>
<h4 id="命令-3"><a class="markdownIt-Anchor" href="#命令-3"></a> 命令</h4>
<ul>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lpush.html">LPUSH</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/list/lpushx.html">LPUSHX</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/list/rpush.html">RPUSH</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/list/rpushx.html">RPUSHX</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/list/lpop.html">LPOP</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/list/rpop.html">RPOP</a>/<a target="_blank" rel="noopener" href="http://redisdoc.com/list/rpoplpush.html">RPOPLPUSH</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lrem.html">LREM</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/llen.html">LLEN</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lindex.html">LINDEX</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/linsert.html">LINSERT</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lset.html">LSET</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lrange.html">LRANGE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/ltrim.html">LTRIM</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/blpop.html">BLPOP</a></li>
<li>
<h3 id="brpop"><a class="markdownIt-Anchor" href="#brpop"></a> <a target="_blank" rel="noopener" href="http://redisdoc.com/list/brpop.html">BRPOP</a></h3>
</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/brpoplpush.html">BRPOPLPUSH</a></li>
</ul>
<h3 id="set"><a class="markdownIt-Anchor" href="#set"></a> Set</h3>
<h4 id="命令-4"><a class="markdownIt-Anchor" href="#命令-4"></a> 命令</h4>
<ul>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sadd.html">SADD</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sismember.html">SISMEMBER</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/spop.html">SPOP</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/srandmember.html">SRANDMEMBER</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/srem.html">SREM</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/smove.html">SMOVE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/scard.html">SCARD</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/smembers.html">SMEMBERS</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sscan.html">SSCAN</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sinter.html">SINTER</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sinterstore.html">SINTERSTORE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sunion.html">SUNION</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sunionstore.html">SUNIONSTORE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sdiff.html">SDIFF</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sdiffstore.html">SDIFFSTORE</a></li>
</ul>
<h3 id="sorted-sets"><a class="markdownIt-Anchor" href="#sorted-sets"></a> Sorted Sets</h3>
<h4 id="命令-5"><a class="markdownIt-Anchor" href="#命令-5"></a> 命令</h4>
<ul>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zadd.html">ZADD</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zscore.html">ZSCORE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zincrby.html">ZINCRBY</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zcard.html">ZCARD</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zcount.html">ZCOUNT</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrange.html">ZRANGE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrevrange.html">ZREVRANGE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrangebyscore.html">ZRANGEBYSCORE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrevrangebyscore.html">ZREVRANGEBYSCORE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrank.html">ZRANK</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrevrank.html">ZREVRANK</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrem.html">ZREM</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zremrangebyrank.html">ZREMRANGEBYRANK</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zremrangebyscore.html">ZREMRANGEBYSCORE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrangebylex.html">ZRANGEBYLEX</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zlexcount.html">ZLEXCOUNT</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zremrangebylex.html">ZREMRANGEBYLEX</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zscan.html">ZSCAN</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zunionstore.html">ZUNIONSTORE</a></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zinterstore.html">ZINTERSTORE</a></li>
</ul>
<h3 id="hyperloglog"><a class="markdownIt-Anchor" href="#hyperloglog"></a> HyperLogLog</h3>
<h3 id="geo"><a class="markdownIt-Anchor" href="#geo"></a> GEO</h3>
<h3 id="pubsub"><a class="markdownIt-Anchor" href="#pubsub"></a> Pub/Sub</h3>
<h3 id="stream"><a class="markdownIt-Anchor" href="#stream"></a> Stream</h3>
<h2 id="高可用可靠"><a class="markdownIt-Anchor" href="#高可用可靠"></a> 高可用，可靠</h2>
<h3 id="复制"><a class="markdownIt-Anchor" href="#复制"></a> 复制</h3>
<p>当有了持久化机制后，确保了redis断电重启后可以恢复好之前的数据，提高了可靠性，但是还无法避免服务不可用的状态，而提高可靠性最为常用的方式就是增加服务的实例节点，增加数据冗余。将一份数据保存到多个服务节点上。即使有的节点宕机情况整体依旧可以提供服务，减少对服务的影响；<br />
redis则采用<strong>读写分离</strong>，主从同步的方式多个实例保存同一份数据；又主库提供写操作然后同步到其他从库；而读操作主从共同提供服务，在普遍读大于写的业务需求下提供较高的可靠性与性能；<br />
而采用一写多从，读写分离的方式可以有效的避免了多个实例之间的分布式多个实例之间的数据一致性与事务的开销。那么具体又是如何实现主从直接的数据一致呢。</p>
<h4 id="数据同步"><a class="markdownIt-Anchor" href="#数据同步"></a> 数据同步</h4>
<p>主要分为三大阶段：</p>
<p><img src="https://gitee.com/xiaozhuo_Q/images/raw/master/blog/image-20210125230430426.png" alt="image-20210125230430426" /></p>
<h5 id="全量同步"><a class="markdownIt-Anchor" href="#全量同步"></a> 全量同步</h5>
<p>首先 由从库发送<strong>replicaof</strong>命令到主库，主库通过<strong>fullresync</strong>命令返回自己的<strong>runid</strong>与offset 偏移量的确认主从关系后开始全量同步；</p>
<p>从库给主库发送<strong>psync</strong>命令，表示要进行数据同步，主库根据这个命令的参数来启动复制。psync命令包含了主库的runlD和复制进度offset两个参数。</p>
<p>主库执行bgsave命令后将生成的rdb文件发送给从库，从库接受rdb文件后先清空本地数据然后载入rdb文件。</p>
<p>主库将同步期间的写命令记录到replication buffer 中，待从库加载完先前的rdb文件就将replication buffer中命令发送给从库执行；完成第一次全量数据的同步；</p>
<h5 id="命令传播"><a class="markdownIt-Anchor" href="#命令传播"></a> 命令传播</h5>
<p>在完成第一次主从同步后，主从之间的数据就达到数据的一致；但这种数据一致情况一定主库执行新的写操作就会被破坏；为此主库将与每一个从库维持一个<strong>长链接</strong>，在执行完写操作后对从服务器执行命令传播操作；即将该写操作发送给从服务器执行，维护主从数据库的一致性；</p>
<h5 id="部分重同步"><a class="markdownIt-Anchor" href="#部分重同步"></a> 部分重同步</h5>
<h3 id="哨兵"><a class="markdownIt-Anchor" href="#哨兵"></a> 哨兵</h3>
<h3 id="集群"><a class="markdownIt-Anchor" href="#集群"></a> 集群</h3>
<h3 id="持久化"><a class="markdownIt-Anchor" href="#持久化"></a> 持久化</h3>
<p>​	Redis是一个内存型的数据库，它所有的数据都是保存在内存中的，而内存虽然可以快速的读写，但是一旦断电，内部存储的所有数据都会丢失。即使是像用作缓存的这种其他数据库仍有备份数据的场景，重新加载数据依旧会对其他的数据库造成一定的压力。所以为了就觉这方面的问题，Redis本身自己就提供了持久化的机制，分别为<strong>AOF日志</strong>与<strong>RDB快照</strong>两种持久化方式。</p>
<h4 id="aof日志"><a class="markdownIt-Anchor" href="#aof日志"></a> AOF日志</h4>
<p>​	AOF日志是redis通过保存每一条对数据库操作的命令来实现最终对数据库所有数据的保存。是数据库常见的一种存储同步数据的一种方式。AOF持久化实现的主要过程通常分为命令追加,文件写入与同步三步。</p>
<h5 id="命令追加"><a class="markdownIt-Anchor" href="#命令追加"></a> 命令追加</h5>
<p>​	服务器在每一次成功执行一条写命令后，就会以redis命令请求协议的格式追加到aof_buf缓冲区的末尾；</p>
<p>​	例如 成功执行一个普通的SET命令后以以下协议格式的内容追加到缓冲区。</p>
<p>​	命令： SET zhuoke blog</p>
<p>​	追加内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*3</span><br><span class="line">$3</span><br><span class="line">set</span><br><span class="line">$6</span><br><span class="line">zhuoke</span><br><span class="line">$4</span><br><span class="line">blog</span><br></pre></td></tr></table></figure>
<p>​	通过这种先执行成功再写入缓冲区的方式  可以<strong>减去命令语法检查操作</strong>与<strong>不会阻塞写操作</strong>却增加了成功执行命令后尚未持久化就宕机丢失数据的风险与在aof写盘时给下一个写操作造成阻塞的风险。</p>
<h5 id="文件同步写入"><a class="markdownIt-Anchor" href="#文件同步写入"></a> 文件同步写入</h5>
<p>​	那么在命令追加阶段的风险其实都是可以通过控制文件的写入与同步的频率来减少这种风险。文件同步写入的操作会在服务器每一个事件循环结束前调用<strong>flushAppendOnlyFile</strong>这个函数来根据服务器的设置提供的频率来判断是否执行文件的同步与执行操作。而这个频率是由服务器提供的一个配置项 <strong>appendfsync</strong>来设置的。<strong>appendfsync</strong>具体有三个选项可供选择</p>
<ul>
<li>
<p>Always 每个写命令执行完立刻<strong>同步写回</strong>到磁盘；</p>
</li>
<li>
<p>Everysec 每秒由一个线程专门负责执行将缓冲区内容写回到文件</p>
</li>
<li>
<p>No 由操作系统控制缓冲区写回到磁盘文件</p>
<p>三种策略对比优缺点</p>
<p><img src="https://gitee.com/xiaozhuo_Q/images/raw/master/blog/image-20210121235326332.png" alt="image-20210121235326332" /></p>
</li>
</ul>
<p>三种策略由上到下性能递增，而可靠性却相反在递减。具体选择就根据应用场景了。redis默认选项是一个折中选择了Everysec。</p>
<h5 id="aof文件载入"><a class="markdownIt-Anchor" href="#aof文件载入"></a> AOF文件载入</h5>
<p>​	AOF光将数据保存到磁盘的操作还不行，我们还需要将文件存储到磁盘的aof日志文件读取会redis的内存空间。<br />
前文提到，aof中具体保存的是redis命令格式的数据。因而只需要一个客户端读取aof文件中的命令发送给redis的服务端即可。<br />
AOF具体的文件的载入的流程如下：</p>
<ul>
<li>服务端启动一个伪客户端（不带网络连接）</li>
<li>读取并执行aof文件中的命令</li>
<li>读取完毕，载入结束</li>
</ul>
<h5 id="aof重写"><a class="markdownIt-Anchor" href="#aof重写"></a> AOF重写</h5>
<p>​	随着aof日志不断的写入，aof文件的大小也会不断的增大，当aof过大时会影响aof追加与载入恢复数据的效率；这个时候redis就提供<strong>aof重写机制</strong>来<strong>减少</strong>aof文件的大小了；<br />
​	AOF会保存redis执行成功的每一条写命令。当多条命令都是对同一个对象进行数据写操作时，往往这多条命令会存在大量冗余的数据；AOF重写是比较有意思的一个点，他重写并不是对原先aof文件内容使用压缩算法进行精简，而是<strong>直接根 据数据库中键值对的最新数据生成对应的写命令</strong>；使原本对应该键值对的多条写操作合并成一条；大大的压缩了aof文件的大小；<br />
​	但是aof重写机制与aof原本机制最大不同在于，它并没有相关的配置项来控制落盘频率，每一次重写所有数据都是直接写入硬盘因而存在大量的读写操作；因为aof重写只有在aof文件比较大的时候才会进行重写，重写的频率并不频繁，所以可以使用较大的开销，直接开启了新的<strong>子进程</strong>对<strong>数据副本</strong>进行重写；</p>
<p>对数据副本进行重写却令重写期间的数据并没有拷贝到数据副本，导致数据库数据与aof文件数据不一致。因此redis在重写期间设置了aof重写的缓冲区，在重写期间，每一条写命令运行成功后除了需要加入原本的aof缓冲区外还需要追加到aof重写的缓冲区；那么整个aof重写的流程如下：</p>
<p><img src="https://gitee.com/xiaozhuo_Q/images/raw/master/blog/image-20210123203057130.png" alt="image-20210123203057130" /></p>
<p>主进程</p>
<ul>
<li>
<p>主进程创建出子进程<strong>bgrewriteao</strong>f并且拷贝出数据副本</p>
</li>
<li>
<p>执行写命令并分别追加到aof缓冲区与aof追加缓冲区；</p>
</li>
<li>
<p>接收到子进程发送的重写完成信号，将重写期间写命令追加到新aof文件中；</p>
</li>
<li>
<p>用新的aof文件覆盖旧aof文件；</p>
</li>
</ul>
<p>子进程</p>
<ul>
<li>开始重写</li>
<li>遍历所有的键值对 （忽略过期的键）</li>
<li>根据键的类型镜像重写</li>
<li>重写完毕</li>
<li>向主进程发送重写完成的信号</li>
</ul>
<p>可以看到由子进程来执行重写的操作可以很大程度避免了主进程的阻塞；但是在fork子进程与重写完毕将aof重写缓冲区内容追加到新aof文件依旧不可避免地产生<strong>阻塞风险</strong>；AOF文件载入时也是逐一执行命令，这样效率也比较慢；</p>
<h4 id="rdb快照"><a class="markdownIt-Anchor" href="#rdb快照"></a> RDB快照</h4>
<p>说完aof日志那就来叨叨另一个持久化机制：RDB快照；与aof记录写命令不同，rdb是直接记录某个是时刻的内存内的数据写到磁盘上；</p>
<p>触发rdb文件生成的方式又两种，一种是命令形式，另一种是在配置文件设置好触发条件的自动间隔性保存；</p>
<p>redis有两个命令可以主动生成rdb文件；</p>
<ul>
<li>save ： 在主线程执行；会阻塞主线程；</li>
<li>bgsave：创建一个子进程来执行；（默认配置选项）</li>
</ul>
<p>配置文件中默认触发条件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line"></span><br><span class="line">save 300 10</span><br><span class="line"></span><br><span class="line">save 60 1000</span><br></pre></td></tr></table></figure>
<p>那么满足其中一个条件即可触发bgsave命令</p>
<p>例如： 在900秒内对数据库执行了一次修改命令 即可触发bgsave命令</p>
<p>最终配置文件中save的配置会被加载到redisServer中的 saveparams数组中；同时redisServer还保存了上次执行完rdb之后成功修改次数的计数器<strong>dirty</strong>与上次执行rdb的unix时间戳lastsave属性；</p>
<p>​	周期性函数serverCron每一执行就会根据这三个值来判断是否执行bgsave函数；</p>
<p>​	bgsave子进程与主进程之间共享所有内存数据；当主进程需要修改数据时就会使用操作系统提供COW(copy on write)写时复制技术；子进程读取复制出来的旧数据；主进程直接修改原来的数据；子进程与主进程之间数据避免影响；</p>
<p>​	<img src="https://gitee.com/xiaozhuo_Q/images/raw/master/blog/image-20210124213009859.png" alt="image-20210124213009859" /></p>
<p>那么对于平时redis我们应该用哪种方式来持久化呢？</p>
<p><img src="https://pic1.zhimg.com/80/v2-005677bf0c9c4937bddce3794f387a77_1440w.jpg?source=1940ef5c" alt="img" /></p>
<p>小孩子才做选择题~</p>
<p>平时日常可混合使用aof与rdb，使用rdb做全量备份，在两次rdb之间使用aof做增量备份；</p>
<p>这样一来，快照不用很频繁地执行，这就避免了频繁fork对主线程的影响。而且，AOF日志也只用记录两次快照间的操作，也就是说，不需要记录所有操作了，因此就不会出现文件过<br />
大的情况了，也可以避免重写开销。</p>
<p><img src="https://gitee.com/xiaozhuo_Q/images/raw/master/blog/image-20210124215636329.png" alt="image-20210124215636329" /></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Raykie</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2020/11/23/Redis%E5%85%A5%E5%9D%91%E7%AC%94%E8%AE%B0/">http://example.com/2020/11/23/Redis%E5%85%A5%E5%9D%91%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Raykie’s blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/redis/">redis</a></div><div class="post_share"><div class="social-share" data-image="https://download.logo.wine/logo/Redis/Redis-Logo.wine.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/25/screw%E4%B8%80%E9%94%AE%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E6%A1%A3/" title="screw一键自动生成数据库文档"><img class="cover" src="https://cdn.jsdelivr.net/gh/GayHub1/images/img/c0b418d39a3444e997791a823bc6bea3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">screw一键自动生成数据库文档</div></div></a></div><div class="next-post pull-right"><a href="/2020/08/15/2020-08-15-Docker%E5%AD%A6%E4%B9%A0%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/" title="Docker学习实践记录"><img class="cover" src="https://cdn.jsdelivr.net/gh/GayHub1/images/img/c0b418d39a3444e997791a823bc6bea3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Docker学习实践记录</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/GayHub1/images/img/jpg.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Raykie</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/GayHub1"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#redis%E5%85%A5%E5%9D%91%E7%AC%94%E8%AE%B0%E9%81%93"><span class="toc-number">1.</span> <span class="toc-text"> Redis入坑笔记（道）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFredis%E6%9F%A5%E7%9C%8B%E6%BA%90%E5%9B%BE%E5%83%8F"><span class="toc-number">1.1.</span> <span class="toc-text"> 什么是Redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text"> Redis安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.1.</span> <span class="toc-text"> Windows安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.2.</span> <span class="toc-text"> Linux安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.2.1.</span> <span class="toc-text"> docker安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.2.2.</span> <span class="toc-text"> 编译安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8redis%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 使用redis客户端连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.</span> <span class="toc-text"> 常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.4.</span> <span class="toc-text"> 数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dict-%E5%AD%97%E5%85%B8%E5%93%88%E5%B8%8C%E8%A1%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text"> Dict 字典&#x2F;哈希表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 整数集合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 双向链表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8"><span class="toc-number">1.4.4.</span> <span class="toc-text"> 压缩列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#skiplist-%E8%B7%B3%E8%B7%83%E8%A1%A8"><span class="toc-number">1.4.5.</span> <span class="toc-text"> skiplist 跳跃表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sds-%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.4.6.</span> <span class="toc-text"> SDS 简单动态字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-model"><span class="toc-number">1.4.7.</span> <span class="toc-text"> Redis Model</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.5.</span> <span class="toc-text"> 数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#string"><span class="toc-number">1.5.1.</span> <span class="toc-text"> String</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4"><span class="toc-number">1.5.1.1.</span> <span class="toc-text"> 命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hash"><span class="toc-number">1.5.2.</span> <span class="toc-text"> Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4-2"><span class="toc-number">1.5.2.1.</span> <span class="toc-text"> 命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#list"><span class="toc-number">1.5.3.</span> <span class="toc-text"> List</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4-3"><span class="toc-number">1.5.3.1.</span> <span class="toc-text"> 命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#brpop"><span class="toc-number">1.5.4.</span> <span class="toc-text"> BRPOP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set"><span class="toc-number">1.5.5.</span> <span class="toc-text"> Set</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4-4"><span class="toc-number">1.5.5.1.</span> <span class="toc-text"> 命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sorted-sets"><span class="toc-number">1.5.6.</span> <span class="toc-text"> Sorted Sets</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4-5"><span class="toc-number">1.5.6.1.</span> <span class="toc-text"> 命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hyperloglog"><span class="toc-number">1.5.7.</span> <span class="toc-text"> HyperLogLog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#geo"><span class="toc-number">1.5.8.</span> <span class="toc-text"> GEO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pubsub"><span class="toc-number">1.5.9.</span> <span class="toc-text"> Pub&#x2F;Sub</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stream"><span class="toc-number">1.5.10.</span> <span class="toc-text"> Stream</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%AF%E9%9D%A0"><span class="toc-number">1.6.</span> <span class="toc-text"> 高可用，可靠</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 复制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">1.6.1.1.</span> <span class="toc-text"> 数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5"><span class="toc-number">1.6.1.1.1.</span> <span class="toc-text"> 全量同步</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E4%BC%A0%E6%92%AD"><span class="toc-number">1.6.1.1.2.</span> <span class="toc-text"> 命令传播</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E9%87%8D%E5%90%8C%E6%AD%A5"><span class="toc-number">1.6.1.1.3.</span> <span class="toc-text"> 部分重同步</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%A8%E5%85%B5"><span class="toc-number">1.6.2.</span> <span class="toc-text"> 哨兵</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-number">1.6.3.</span> <span class="toc-text"> 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.6.4.</span> <span class="toc-text"> 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#aof%E6%97%A5%E5%BF%97"><span class="toc-number">1.6.4.1.</span> <span class="toc-text"> AOF日志</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%BF%BD%E5%8A%A0"><span class="toc-number">1.6.4.1.1.</span> <span class="toc-text"> 命令追加</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%86%99%E5%85%A5"><span class="toc-number">1.6.4.1.2.</span> <span class="toc-text"> 文件同步写入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#aof%E6%96%87%E4%BB%B6%E8%BD%BD%E5%85%A5"><span class="toc-number">1.6.4.1.3.</span> <span class="toc-text"> AOF文件载入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#aof%E9%87%8D%E5%86%99"><span class="toc-number">1.6.4.1.4.</span> <span class="toc-text"> AOF重写</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rdb%E5%BF%AB%E7%85%A7"><span class="toc-number">1.6.4.2.</span> <span class="toc-text"> RDB快照</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/22/OppoA8/" title="OppoA8搞机的一次记录"><img src="https://cdn.jsdelivr.net/gh/GayHub1/images/img/c0b418d39a3444e997791a823bc6bea3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OppoA8搞机的一次记录"/></a><div class="content"><a class="title" href="/2023/06/22/OppoA8/" title="OppoA8搞机的一次记录">OppoA8搞机的一次记录</a><time datetime="2023-06-21T16:09:24.000Z" title="发表于 2023-06-22 00:09:24">2023-06-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/29/Android%E5%BC%80%E5%8F%91%E6%9D%82%E8%AE%B0/" title="Android杂记"><img src="https://developer.android.google.cn/courses/images/android-for-developers.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android杂记"/></a><div class="content"><a class="title" href="/2023/05/29/Android%E5%BC%80%E5%8F%91%E6%9D%82%E8%AE%B0/" title="Android杂记">Android杂记</a><time datetime="2023-05-28T16:00:00.000Z" title="发表于 2023-05-29 00:00:00">2023-05-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/28/RocketMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="RocketMQ学习笔记"><img src="https://cdn.jsdelivr.net/gh/GayHub1/images@master/img/20230529225317.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RocketMQ学习笔记"/></a><div class="content"><a class="title" href="/2023/05/28/RocketMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="RocketMQ学习笔记">RocketMQ学习笔记</a><time datetime="2023-05-27T16:00:00.000Z" title="发表于 2023-05-28 00:00:00">2023-05-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/13/2021/" title="2021"><img src="https://cdn.jsdelivr.net/gh/GayHub1/images/img/c0b418d39a3444e997791a823bc6bea3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021"/></a><div class="content"><a class="title" href="/2022/02/13/2021/" title="2021">2021</a><time datetime="2022-02-12T16:02:15.000Z" title="发表于 2022-02-13 00:02:15">2022-02-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/13/%E9%BB%91%E7%BE%A4%E6%99%96%E6%8A%98%E8%85%BE%E7%AC%94%E8%AE%B0/" title="黑群晖 折腾笔记"><img src="https://cdn.jsdelivr.net/gh/GayHub1/images@master/img/product_h_2_advanced_data_management.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="黑群晖 折腾笔记"/></a><div class="content"><a class="title" href="/2022/02/13/%E9%BB%91%E7%BE%A4%E6%99%96%E6%8A%98%E8%85%BE%E7%AC%94%E8%AE%B0/" title="黑群晖 折腾笔记">黑群晖 折腾笔记</a><time datetime="2022-02-12T16:02:15.000Z" title="发表于 2022-02-13 00:02:15">2022-02-13</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2023 By Raykie</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn"><img class="icp-icon" src="https://cdn.jsdelivr.net/gh/GayHub1/images@master/img/icp.png"><span>粤ICP备2023064499号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'hxN4EMnnWWFNeyk4xbNxQJT7-gzGzoHsz',
      appKey: 'lewYKS5k1rb7D5sVgI4QeTAx',
      avatar: 'monsterid',
      serverURLs: 'http://raykie.cn/',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: true
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=monsterid'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'http://raykie.cn/'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'hxN4EMnnWWFNeyk4xbNxQJT7-gzGzoHsz',
        "X-LC-Key": 'lewYKS5k1rb7D5sVgI4QeTAx',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="397524102" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script>(() => {
  const isChatBtn = true
  const isChatHideShow = false

  if (isChatBtn) {
    const close = () => {
      Chatra('minimizeWidget')
      Chatra('hide')
    }

    const open = () => {
      Chatra('openChat', true)
      Chatra('show')
    }

    window.ChatraSetup = {
      startHidden: true
    }
  
    window.chatBtnFn = () => {
      const isShow = document.getElementById('chatra').classList.contains('chatra--expanded')
      isShow ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        Chatra('hide')
      },
      show: () => {
        Chatra('show')
      }
    }
  }

  (function(d, w, c) {
    w.ChatraID = 'buCYRDsQchrRDzTXZ'
    var s = d.createElement('script')
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments)
    }
    s.async = true
    s.src = 'https://call.chatra.io/chatra.js'
    if (d.head) d.head.appendChild(s)
  })(document, window, 'Chatra')

})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>